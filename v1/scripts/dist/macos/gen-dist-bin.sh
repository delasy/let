#!/usr/bin/env bash

set -e

VERSION=$1

DIR_BUILD=build
DIR_DIST=dist
DIR_DIST_TAR=${DIR_DIST}/tar
DIR_DIST_TAR_BIN=${DIR_DIST_TAR}/bin
DIR_DIST_TAR_SHARE=${DIR_DIST_TAR}/share
DIR_DIST_TAR_SHARE_DOC=${DIR_DIST_TAR_SHARE}/doc
DIR_DIST_TAR_SHARE_DOC_LET=${DIR_DIST_TAR_SHARE_DOC}/let
DIR_DIST_TAR_SHARE_MAN=${DIR_DIST_TAR_SHARE}/man
DIR_DIST_TAR_SHARE_MAN_MAN1=${DIR_DIST_TAR_SHARE_MAN}/man1
DIR_SCRIPTS=scripts
DIR_SCRIPTS_DIST=${DIR_SCRIPTS}/dist
NAME_FILE=let-v${VERSION}
NAME_TARBALL=${NAME_FILE}-darwin-x64.tar.gz

mkdir -p ${DIR_DIST}
mkdir -p ${DIR_DIST_TAR}
mkdir -p ${DIR_DIST_TAR_BIN}
mkdir -p ${DIR_DIST_TAR_SHARE}
mkdir -p ${DIR_DIST_TAR_SHARE_DOC}
mkdir -p ${DIR_DIST_TAR_SHARE_DOC_LET}
mkdir -p ${DIR_DIST_TAR_SHARE_MAN}
mkdir -p ${DIR_DIST_TAR_SHARE_MAN_MAN1}

rm -f ${DIR_DIST}/NAME_TARBALL

${DIR_SCRIPTS}/init.sh release
${DIR_SCRIPTS}/build.sh

cp ${DIR_BUILD}/let ${DIR_DIST_TAR_BIN}
cp CHANGELOG.md ${DIR_DIST_TAR}
cp CHANGELOG.md ${DIR_DIST_TAR_SHARE_DOC_LET}
cp LICENSE ${DIR_DIST_TAR}
cp LICENSE ${DIR_DIST_TAR_SHARE_DOC_LET}
cp README.md ${DIR_DIST_TAR}
cp README.md ${DIR_DIST_TAR_SHARE_DOC_LET}
cp ${DIR_SCRIPTS_DIST}/let.1 ${DIR_DIST_TAR_SHARE_MAN_MAN1}
cp ${DIR_SCRIPTS_DIST}/postinstall.sh ${DIR_DIST_TAR}
cp ${DIR_SCRIPTS_DIST}/preinstall.sh ${DIR_DIST_TAR}
cp ${DIR_SCRIPTS_DIST}/uninstaller.sh ${DIR_DIST_TAR}

cd ${DIR_DIST_TAR}

tar -cf ${NAME_FILE}.tar *
mv ${NAME_FILE}.tar ..

cd ../..

gzip -cf -9 ${DIR_DIST}/${NAME_FILE}.tar > ${DIR_DIST}/${NAME_TARBALL}

rm -f ${DIR_DIST}/${NAME_FILE}.tar
rm -rf ${DIR_DIST_TAR}
